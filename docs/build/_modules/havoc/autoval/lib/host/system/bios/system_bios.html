

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>havoc.autoval.lib.host.system.bios.system_bios &mdash; UHDDT PyDoc 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../../" src="../../../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../../index.html">
          

          
            
            <img src="../../../../../../../_static/fbicon.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">havoc</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">UHDDT PyDoc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../../../index.html">Module code</a> &raquo;</li>
        
      <li>havoc.autoval.lib.host.system.bios.system_bios</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for havoc.autoval.lib.host.system.bios.system_bios</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">havoc.autotest_testfiles.validation_utils.lib.system_config.dmidecode_parser</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">DmidecodeParser</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">havoc.lib.filesystem_actions</span> <span class="k">import</span> <span class="n">FilesystemActions</span>
<span class="kn">from</span> <span class="nn">havoc.autotest_testfiles.validation_utils.lib.autoval</span> <span class="k">import</span> <span class="n">AutovalUtils</span>
<span class="kn">from</span> <span class="nn">havoc.autotest_testfiles.validation_utils.lib.site_utils</span> <span class="k">import</span> <span class="n">SiteUtils</span>
<span class="kn">from</span> <span class="nn">havoc.lib.decorators</span> <span class="k">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">havoc.autotest_testfiles.validation_utils.lib.autoval_thread</span> <span class="k">import</span> <span class="n">AutovalThread</span>
<span class="kn">from</span> <span class="nn">havoc.autotest_testfiles.validation_utils.lib.autoval_exceptions</span> <span class="k">import</span> <span class="n">TestError</span>


<span class="n">EINJ_INTERFACE</span> <span class="o">=</span> <span class="s2">&quot;/sys/kernel/debug/apei/einj&quot;</span>
<span class="n">HOST_ADDR</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">ENABLED</span> <span class="o">=</span> <span class="s2">&quot;enabled&quot;</span>


<span class="n">BIOS_DUMP_LOCATION</span> <span class="o">=</span> <span class="s2">&quot;bios_settings.txt&quot;</span>
<span class="n">BIOS_SETTING_UPDATED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">NO_CHANGE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">BIOS_SETTING_UPDATE_FAILED</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">RESULT_DIR</span> <span class="o">=</span> <span class="s2">&quot;/tmp&quot;</span>

<span class="n">BIOS_SETTING_OPT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;enable&quot;</span><span class="p">:</span> <span class="s2">&quot;Enable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;disable&quot;</span><span class="p">:</span> <span class="s2">&quot;Disable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="s2">&quot;Minimum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="s2">&quot;Maximum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;auto&quot;</span><span class="p">:</span> <span class="s2">&quot;Auto&quot;</span><span class="p">,</span>
    <span class="s2">&quot;usb&quot;</span><span class="p">:</span> <span class="s2">&quot;USB&quot;</span><span class="p">,</span>
    <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="s2">&quot;Network&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hard disk&quot;</span><span class="p">:</span> <span class="s2">&quot;Hard Disk&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cd/dvd&quot;</span><span class="p">:</span> <span class="s2">&quot;CD/DVD&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">STANDARD_ERROR_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;memory_correctable&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000008&quot;</span><span class="p">,</span>
    <span class="s2">&quot;memory_uncorrectable_fatal&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000010&quot;</span><span class="p">,</span>
    <span class="s2">&quot;memory_uncorrectable_non_fatal&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000020&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="SystemBios"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios">[docs]</a><span class="k">class</span> <span class="nc">SystemBios</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="SystemBios.__init__"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idk</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;idk_platform&quot;</span><span class="p">:</span> <span class="s2">&quot;skylake&quot;</span><span class="p">,</span>
            <span class="s2">&quot;idk_server&quot;</span><span class="p">:</span> <span class="s2">&quot;einj/IDK_Server&quot;</span><span class="p">,</span>
            <span class="s2">&quot;idk_client&quot;</span><span class="p">:</span> <span class="s2">&quot;einj/IDK_Client&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span></div>

<div class="viewcode-block" id="SystemBios.cycle_post_bios_upgrade"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.cycle_post_bios_upgrade">[docs]</a>    <span class="k">def</span> <span class="nf">cycle_post_bios_upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">ac_cycle</span><span class="p">()</span></div>

<div class="viewcode-block" id="SystemBios.bios_update"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.bios_update">[docs]</a>    <span class="k">def</span> <span class="nf">bios_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary_path</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">,</span> <span class="n">tool_path</span><span class="p">,</span> <span class="n">toolname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_acpidump</span><span class="p">()</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bios_update_cmd</span><span class="p">(</span><span class="n">binary_path</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">,</span> <span class="n">tool_path</span><span class="p">,</span> <span class="n">toolname</span><span class="p">)</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Running Command </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_working_dir</span><span class="p">()</span>  <span class="c1"># noqa</span>
        <span class="p">)</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span>
            <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Flashing </span><span class="si">%s</span><span class="s2"> Completed - Cycling now..&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">binary_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># type of cycles/reboot vary for different platforms</span>
        <span class="c1"># after bios upgrade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_post_bios_upgrade</span><span class="p">()</span></div>

<div class="viewcode-block" id="SystemBios.bios_inband_update"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.bios_inband_update">[docs]</a>    <span class="k">def</span> <span class="nf">bios_inband_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dut_dir</span><span class="p">,</span> <span class="n">source_binary</span><span class="p">):</span>
        <span class="n">_host</span> <span class="o">=</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">get_host</span><span class="p">()</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">set_host</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_acpidump</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">bios</span><span class="o">.</span><span class="n">get_bios_vendor</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;coreboot&quot;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;flashrom -p internal --ifd -i bios -N -w </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source_binary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if the firmware binaries are already extracted. if not, extract</span>
            <span class="c1"># it independent of the compression type i.e .tgz, .tar.gz, .zip etc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_binary_contents</span><span class="p">(</span><span class="n">dut_dir</span><span class="p">):</span>
                <span class="n">remote_module_function</span> <span class="o">=</span> <span class="s2">&quot;extract&quot;</span>
                <span class="n">remote_module</span> <span class="o">=</span> <span class="s2">&quot;validation_utils.lib.generic_utils&quot;</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="s2">&quot;GenericUtils&quot;</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_binary</span><span class="p">,</span> <span class="n">dut_dir</span><span class="p">]</span>
                <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">run_remote_module</span><span class="p">(</span>
                    <span class="n">remote_module</span><span class="p">,</span> <span class="n">remote_module_function</span><span class="p">,</span>
                    <span class="n">params</span><span class="p">,</span> <span class="n">class_name</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_binary_contents</span><span class="p">(</span><span class="n">dut_dir</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cd </span><span class="si">%s</span><span class="s2">;/bin/sh ./run_script&quot;</span> <span class="o">%</span> <span class="n">dut_dir</span>
            <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Starting BIOS update&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_script</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dut_dir</span><span class="p">)</span>

        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
            <span class="s2">&quot;Flashing </span><span class="si">%s</span><span class="s2"> Completed - Cycling now..&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dut_dir</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># type of cycles/reboot vary for different platforms</span>
        <span class="c1"># after bios upgrade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_post_bios_upgrade</span><span class="p">()</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">set_host</span><span class="p">(</span><span class="n">_host</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">dut_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>  <span class="c1"># noqa</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">dut_dir</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SystemBios.check_binary_contents"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_binary_contents">[docs]</a>    <span class="k">def</span> <span class="nf">check_binary_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary_loc</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function check the extracted binary package if it contain</span>
<span class="sd">        require run_script. run_script is mandatory for bios upgrade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">binaries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;ls </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">binary_loc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">binaries</span> <span class="ow">and</span> <span class="s1">&#39;run_script&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">binaries</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="c1"># firmware directory already extracted.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;No run_script found at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">binary_loc</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SystemBios.rdmsr"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.rdmsr">[docs]</a>    <span class="k">def</span> <span class="nf">rdmsr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">register</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x400</span><span class="p">,</span> <span class="mh">0x450</span><span class="p">):</span>

            <span class="n">_reg</span> <span class="o">=</span> <span class="s2">&quot;0x</span><span class="si">%0X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">register</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;/sbin/rdmsr </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_reg</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">msr</span><span class="p">[</span><span class="n">_reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">return</span> <span class="n">msr</span></div>

<div class="viewcode-block" id="SystemBios.get_diff_in_msr_groups"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_diff_in_msr_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_diff_in_msr_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msr_before</span><span class="p">,</span> <span class="n">msr_after</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MSR registers (400h ~ 44Fh) are grouped.</span>
<span class="sd">        Each group contains 4 registers</span>
<span class="sd">            - Control  (400h + x*4h)</span>
<span class="sd">            - Status   (401h + x*4h)</span>
<span class="sd">            - Addr     (402h + x*4h)</span>
<span class="sd">            - Misc     (403h + x*4h)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># validate if the msr_values provided are divisible by 4</span>
        <span class="c1"># as we validate each group and a group contains 4 registers</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msr_before</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                <span class="s2">&quot;msr_before data is not valid to compare as data is always&quot;</span>
                <span class="s2">&quot; sets of 4 registers&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">msr_after</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                <span class="s2">&quot;msr_after data is not valid to compare as data is always&quot;</span>
                <span class="s2">&quot; sets of 4 registers&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">msr_before</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msr_after</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                <span class="s2">&quot;comparision cannot be done as no of register in msr_before: </span><span class="si">%d</span><span class="s2">  and msr_after: </span><span class="si">%d</span><span class="s2"> are not equal&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msr_before</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">msr_after</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">diff_registers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_msr_by_group</span><span class="p">(</span><span class="n">msr_before</span><span class="p">,</span> <span class="n">msr_after</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">diff_registers</span></div>

<div class="viewcode-block" id="SystemBios.compare_msr_by_group"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.compare_msr_by_group">[docs]</a>    <span class="k">def</span> <span class="nf">compare_msr_by_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msr_before</span><span class="p">,</span> <span class="n">msr_after</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Comparison for the MSRs.</span>
<span class="sd">        For each MSR register group,</span>
<span class="sd">         1. Check the MSR Status Registers first</span>
<span class="sd">              - If not 0, then compare the MSR Addr/Misc to seek for differences.</span>
<span class="sd">                 -- If differences found, log the difference as failure</span>
<span class="sd">              - If 0, then ignore the MSR Addr/Misc comparison</span>
<span class="sd">        2. Check and compare the MSR Control Registers and log the difference</span>
<span class="sd">           as failure if any</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">group_reg</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">msr_before</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msr_before</span><span class="p">)),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="n">control_reg</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span> <span class="n">addr_reg</span><span class="p">,</span> <span class="n">misc_reg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">group_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">group_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">group_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">group_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">diff_noticed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">all_diff_before</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_diff_after</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">msr_after</span><span class="p">[</span><span class="n">status_reg</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">addr_reg</span><span class="p">]</span> <span class="o">!=</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">addr_reg</span><span class="p">]:</span>
                    <span class="n">diff_noticed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">misc_reg</span><span class="p">]</span> <span class="o">!=</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">misc_reg</span><span class="p">]:</span>
                    <span class="n">diff_noticed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">control_reg</span><span class="p">]</span> <span class="o">!=</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">control_reg</span><span class="p">]:</span>
                <span class="n">diff_noticed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">diff_noticed</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;msr_group_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">control_reg</span><span class="p">,</span> <span class="n">misc_reg</span><span class="p">)</span>
                <span class="n">diff_before</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;control&quot;</span><span class="p">:</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">control_reg</span><span class="p">],</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">status_reg</span><span class="p">],</span>
                    <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">addr_reg</span><span class="p">],</span>
                    <span class="s2">&quot;misc&quot;</span><span class="p">:</span> <span class="n">msr_before</span><span class="p">[</span><span class="n">misc_reg</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="n">diff_after</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;control&quot;</span><span class="p">:</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">control_reg</span><span class="p">],</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">status_reg</span><span class="p">],</span>
                    <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">addr_reg</span><span class="p">],</span>
                    <span class="s2">&quot;misc&quot;</span><span class="p">:</span> <span class="n">msr_after</span><span class="p">[</span><span class="n">misc_reg</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="n">all_diff_before</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">diff_before</span><span class="p">})</span>
                <span class="n">all_diff_after</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">diff_after</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">compare_configs</span><span class="p">(</span><span class="n">all_diff_before</span><span class="p">,</span> <span class="n">all_diff_after</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.install_acpidump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.install_acpidump">[docs]</a>    <span class="k">def</span> <span class="nf">install_acpidump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set host to dut for installing rpms</span>
        <span class="n">old_host</span> <span class="o">=</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">get_host</span><span class="p">()</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">set_host</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="c1"># Install acpidump tool on the system before the bios update</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">install_rpms</span><span class="p">([</span><span class="s2">&quot;acpica-tools&quot;</span><span class="p">])</span>
        <span class="c1"># set autovalutils host to old_host</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">set_host</span><span class="p">(</span><span class="n">old_host</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.parse_dump_file"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.parse_dump_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dump_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dump_file</span><span class="p">,</span> <span class="n">seperator_patter</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dump_handler</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dump_handler</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dump_parsed_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">curr_line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">seperator_patter</span><span class="p">,</span> <span class="n">curr_line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">curr_key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">dump_parsed_data</span><span class="p">[</span><span class="n">curr_key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dump_parsed_data</span><span class="p">[</span><span class="n">curr_key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">curr_line</span>
        <span class="k">return</span> <span class="n">dump_parsed_data</span></div>

<div class="viewcode-block" id="SystemBios.compare_lspci_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.compare_lspci_dump">[docs]</a>    <span class="k">def</span> <span class="nf">compare_lspci_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acpi_dump_file_before</span><span class="p">,</span> <span class="n">acpi_dump_file_after</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function compares each line of acpi dumps and return the</span>
<span class="sd">        table whose values differ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lspci_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\w+\:\w+\.\w+\s+.*\(rev\s+\w+\))&quot;</span>
        <span class="n">lspci_dump_before_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dump_file</span><span class="p">(</span>
            <span class="n">acpi_dump_file_before</span><span class="p">,</span> <span class="n">lspci_pattern</span>
        <span class="p">)</span>
        <span class="n">lspci_dump_after_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dump_file</span><span class="p">(</span>
            <span class="n">acpi_dump_file_after</span><span class="p">,</span> <span class="n">lspci_pattern</span>
        <span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">compare_configs</span><span class="p">(</span>
            <span class="n">lspci_dump_before_logs</span><span class="p">,</span> <span class="n">lspci_dump_after_logs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">diff</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="SystemBios.compare_acpi_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.compare_acpi_dump">[docs]</a>    <span class="k">def</span> <span class="nf">compare_acpi_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acpi_dump_file_before</span><span class="p">,</span> <span class="n">acpi_dump_file_after</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function compares each line of acpi dumps and return the</span>
<span class="sd">        table whose values differ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acpi_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(\w+)\s+\@\s+\w+&quot;</span>
        <span class="n">acpi_dump_before_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dump_file</span><span class="p">(</span>
            <span class="n">acpi_dump_file_before</span><span class="p">,</span> <span class="n">acpi_pattern</span>
        <span class="p">)</span>
        <span class="n">acpi_dump_after_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dump_file</span><span class="p">(</span><span class="n">acpi_dump_file_after</span><span class="p">,</span> <span class="n">acpi_pattern</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">compare_configs</span><span class="p">(</span><span class="n">acpi_dump_before_logs</span><span class="p">,</span> <span class="n">acpi_dump_after_logs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">diff</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="SystemBios.get_bios_full_info"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_bios_full_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_bios_full_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dmidecode -t bios&quot;</span>
        <span class="n">bios_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DmidecodeParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse_dmidecode_output</span><span class="p">(</span><span class="n">bios_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.get_bios_vendor"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_bios_vendor">[docs]</a>    <span class="k">def</span> <span class="nf">get_bios_vendor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dmidecode --string bios-vendor&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.get_ec_ver"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_ec_ver">[docs]</a>    <span class="k">def</span> <span class="nf">get_ec_ver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;version:\s(\w+)&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">version</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.get_bios_ver"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_bios_ver">[docs]</a>    <span class="k">def</span> <span class="nf">get_bios_ver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bios_vendor</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;coreboot&quot;</span><span class="p">:</span>
            <span class="n">query_ver</span> <span class="o">=</span> <span class="s2">&quot;vpd -g internal_versions&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query_ver</span><span class="p">)</span>
            <span class="n">result_js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">result_js</span><span class="p">[</span><span class="s1">&#39;coreboot&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ver_inb</span> <span class="o">=</span> <span class="s2">&quot;dmidecode -t bios&quot;</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ver_inb</span><span class="p">)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Version:\s+(\w+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">state</span></div>

<div class="viewcode-block" id="SystemBios.get_dut_dir"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_dut_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_dut_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toolpath</span><span class="p">):</span>
        <span class="n">dut_dir</span> <span class="o">=</span> <span class="n">SiteUtils</span><span class="o">.</span><span class="n">get_dut_tmpdir</span><span class="p">()</span>
        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">toolpath</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dut_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dut_dir</span></div>

<div class="viewcode-block" id="SystemBios.get_working_dir"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_working_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_working_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span></div>

<div class="viewcode-block" id="SystemBios.copy_binaries_dut"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.copy_binaries_dut">[docs]</a>    <span class="k">def</span> <span class="nf">copy_binaries_dut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cp -r </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;error copying </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>

<div class="viewcode-block" id="SystemBios.get_bios_settings_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_bios_settings_dump">[docs]</a>    <span class="k">def</span> <span class="nf">get_bios_settings_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Function to get BIOS Dump.</span>
<span class="sd">        # @ret  - Location of the dump file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">make</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">get_manufacturer</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;/o /s </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="c1"># For wiwynn system there is an extra argument /b to be passed</span>
        <span class="c1"># to get the boot order settings in dump</span>
        <span class="k">if</span> <span class="n">make</span> <span class="o">==</span> <span class="s2">&quot;wiwynn&quot;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; /b&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_bios_settings</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_path</span></div>

<div class="viewcode-block" id="SystemBios.check_bios_settings"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_bios_settings">[docs]</a>    <span class="k">def</span> <span class="nf">check_bios_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed_new_bios</span><span class="p">,</span> <span class="n">expected_settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function checks if all the expected settings are properly set by</span>
<span class="sd">        by looking into the parsed bios settings and confirms if everything is</span>
<span class="sd">        set correctly and raises an error if the settings do not match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">curr_ques</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">expected_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parsed_token</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;token&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                        <span class="s2">&quot;Multiple Values found for </span><span class="si">%s</span><span class="s2"> Need BIOS token&quot;</span> <span class="o">%</span>
                        <span class="n">curr_ques</span>
                    <span class="p">)</span>
                <span class="n">parsed_token</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">parsed_token</span>
            <span class="k">if</span> <span class="s2">&quot;Options&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">expected_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Options&quot;</span><span class="p">]</span>
                <span class="n">options_list</span> <span class="o">=</span> <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">parsed_token</span><span class="p">][</span><span class="s2">&quot;Options&quot;</span><span class="p">]</span>
                <span class="n">expected_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;\*(.*)</span><span class="si">%s</span><span class="s2">(.*)&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expected_value</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span>
                <span class="p">)</span>
                <span class="n">matched_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">expected_regex</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">options_list</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                        <span class="s2">&quot;Bios Setup Question: </span><span class="si">%s</span><span class="s2">, Token: </span><span class="si">%s</span><span class="s2">,&quot;</span>
                        <span class="s2">&quot; Expected: </span><span class="si">%s</span><span class="s2">, Actual: Not set &quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">curr_ques</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">parsed_token</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">expected_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
                <span class="n">actual_value</span> <span class="o">=</span> <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">parsed_token</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
                <span class="c1"># When we dump the BIOS settings we will be seeing value</span>
                <span class="c1"># enclosed in &lt;&gt; characters. So just read the value of setting</span>
                <span class="c1"># for comparision by removing the &lt;|&gt; symbols</span>
                <span class="n">actual_value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">actual_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">expected_value</span> <span class="o">==</span> <span class="n">actual_value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                        <span class="s2">&quot;Bios Setup Question: </span><span class="si">%s</span><span class="s2">, Token: </span><span class="si">%s</span><span class="s2">,&quot;</span>
                        <span class="s2">&quot; Expected: </span><span class="si">%s</span><span class="s2">, Actual: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">curr_ques</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">,</span> <span class="n">actual_value</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;ListOrder&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">expected_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;ListOrder&quot;</span><span class="p">]</span>
                <span class="n">actual_value</span> <span class="o">=</span> <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">parsed_token</span><span class="p">][</span><span class="s2">&quot;ListOrder&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">expected_value</span> <span class="o">==</span> <span class="n">actual_value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                        <span class="s2">&quot;Bios Setup Question: </span><span class="si">%s</span><span class="s2">, Token: </span><span class="si">%s</span><span class="s2">,&quot;</span>
                        <span class="s2">&quot; Expected: </span><span class="si">%s</span><span class="s2">, Actual: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">curr_ques</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">,</span> <span class="n">actual_value</span><span class="p">)</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.update_bios_settings"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.update_bios_settings">[docs]</a>    <span class="k">def</span> <span class="nf">update_bios_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bios_settings</span><span class="p">,</span> <span class="n">dump_file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Function to update  BIOS setting.</span>
<span class="sd">        # @param bios_settings - Dictonary with BIOS_Option:option</span>
<span class="sd">        #       Supported options - enable/disable/minimum/maximum/auto</span>
<span class="sd">        # @ret  - BIOS_SETTING_UPDATED/BIOS_SETTING_UPDATE_FAILED/NO_CHANGE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">NO_CHANGE</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dump_file_path</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bios_settings_dump</span><span class="p">(</span><span class="n">dump</span><span class="p">)</span>
        <span class="n">new_dump</span><span class="p">,</span> <span class="n">parsed_old_bios</span><span class="p">,</span> <span class="n">parsed_new_bios</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_bios_dump</span><span class="p">(</span>
            <span class="n">bios_settings</span><span class="p">,</span> <span class="n">dump</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Validating the BIOS changes by comparing&quot;</span>
            <span class="s2">&quot; new settings to initial settings...&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bios_settings</span><span class="p">(</span><span class="n">parsed_new_bios</span><span class="p">,</span> <span class="n">bios_settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_bios_setting_from_dump</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">new_dump</span><span class="p">)</span>
        <span class="n">my_changed_dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bios_settings_dump</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_after_changed&quot;</span> <span class="o">%</span> <span class="n">new_dump</span><span class="p">)</span>
        <span class="n">bios_after_change_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bios_dump_file</span><span class="p">(</span><span class="n">my_changed_dump</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bios_settings</span><span class="p">(</span><span class="n">bios_after_change_parsed</span><span class="p">,</span> <span class="n">bios_settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -f </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">my_changed_dump</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bios_after_change_parsed</span> <span class="o">==</span> <span class="n">parsed_old_bios</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">BIOS_SETTING_UPDATED</span>
        <span class="k">return</span> <span class="n">res</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ## Function to update  BIOS setting from the given dump.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SystemBios.update_bios_setting_from_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.update_bios_setting_from_dump">[docs]</a>    <span class="k">def</span> <span class="nf">update_bios_setting_from_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;Bios dump location not specified&quot;</span><span class="p">)</span>
        <span class="n">make</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">get_manufacturer</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;/i /s </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">make</span> <span class="o">==</span> <span class="s2">&quot;wiwynn&quot;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; /b&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_bios_settings</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bios config settings applied&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;system rebooting...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">inband</span><span class="o">.</span><span class="n">reboot</span><span class="p">(</span><span class="n">shutdown_cmd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_path</span></div>

<div class="viewcode-block" id="SystemBios.dump_bios_settings"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.dump_bios_settings">[docs]</a>    <span class="k">def</span> <span class="nf">dump_bios_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Function to set/get BIOS setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scelnx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">get_scelnx_tool_path</span><span class="p">()</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scelnx</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;command not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;scelnx not installed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to get/set BIOS information, Error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.get_port_ids"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_port_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_port_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_ports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;pcitool -j&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_keys</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;express_type&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="n">_keys</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">output</span><span class="p">[</span><span class="n">_keys</span><span class="p">][</span><span class="s2">&quot;express_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;endpoint&quot;</span>
            <span class="p">):</span>
                <span class="n">all_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">_keys</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pcie_ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">port</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">all_ports</span> <span class="k">if</span> <span class="n">port</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;00&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pcie_ports</span></div>

<div class="viewcode-block" id="SystemBios.generate_pcie_port_address"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.generate_pcie_port_address">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pcie_port_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+):(\w+).(\w+)&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-0b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-0b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-0b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">function</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-0b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">reserved</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-0b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">port_address</span> <span class="o">=</span> <span class="n">segment</span> <span class="o">+</span> <span class="n">bus</span> <span class="o">+</span> <span class="n">device</span> <span class="o">+</span> <span class="n">function</span> <span class="o">+</span> <span class="n">reserved</span>
            <span class="n">port_address</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">port_address</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;PCIE Port </span><span class="si">{}</span><span class="s2">, Address </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">port_address</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">port_address</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;Did not get address for port </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span></div>

<div class="viewcode-block" id="SystemBios.get_bus_device_fun"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_bus_device_fun">[docs]</a>    <span class="k">def</span> <span class="nf">get_bus_device_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_id</span><span class="p">):</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+):(\w+).(\w+)&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">port_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span></div>

<div class="viewcode-block" id="SystemBios.inject_pcie_error"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.inject_pcie_error">[docs]</a>    <span class="k">def</span> <span class="nf">inject_pcie_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pcie_einj_type</span><span class="p">,</span>
        <span class="n">port_id_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validate_injection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">pcie_error_method</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pcie_express_correctable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pcie_correctable_error_cmds</span><span class="p">,</span>
            <span class="s2">&quot;pcie_express_uncorrectable_fatal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pcie_uncorrectable_error_fatal_cmds</span><span class="p">,</span>
            <span class="s2">&quot;pcie_express_uncorrectable_non_fatal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pcie_uncorrectable_error_nonfatal_cmds</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_host</span> <span class="o">=</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">get_host</span><span class="p">()</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">set_host</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">port_id_list</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">remote_module_function</span> <span class="o">=</span> <span class="s2">&quot;find_pci_endpoints&quot;</span>
            <span class="n">remote_module</span> <span class="o">=</span> <span class="s2">&quot;validation_utils.lib.find_pci_endpoints&quot;</span>

            <span class="n">port_id_list</span> <span class="o">=</span> <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">run_remote_module</span><span class="p">(</span>
                <span class="n">remote_module</span><span class="p">,</span> <span class="n">remote_module_function</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">class_name</span>
            <span class="p">)</span>


        <span class="n">einj_failures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">port_id_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;No Error_Injection capable port found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">einj_failures</span>

        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_id_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                <span class="n">injected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">injected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                <span class="n">sel_log_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">log_message</span><span class="p">()</span>
            <span class="n">command_list</span> <span class="o">=</span> <span class="n">pcie_error_method</span><span class="p">[</span><span class="n">pcie_einj_type</span><span class="p">](</span><span class="n">port</span><span class="p">)</span>
            <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Injecting </span><span class="si">{}</span><span class="s2"> on port </span><span class="si">{}</span><span class="s2"> now&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pcie_einj_type</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">command_list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                            <span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">EINJ_INTERFACE</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                        <span class="n">injected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_log_for_einj</span><span class="p">(</span>
                            <span class="s2">&quot;pcie&quot;</span><span class="p">,</span>
                            <span class="n">sel_log_before</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">injected</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;timed out&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="c1"># Wait till the Auto Crash Dump is collected</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">reboot_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                        <span class="n">injected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_log_for_einj</span><span class="p">(</span>
                            <span class="s2">&quot;pcie&quot;</span><span class="p">,</span>
                            <span class="n">sel_log_before</span>
                        <span class="p">)</span>
            <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span>
                <span class="n">injected</span><span class="p">,</span>
                <span class="s2">&quot;inject </span><span class="si">%s</span><span class="s2"> error on pcie </span><span class="si">%s</span><span class="s2"> port&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pcie_einj_type</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                <span class="n">raise_on_fail</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">injected</span><span class="p">:</span>
                <span class="n">einj_failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">set_host</span><span class="p">(</span><span class="n">_host</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">einj_failures</span></div>

<div class="viewcode-block" id="SystemBios.inject_mem_error"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.inject_mem_error">[docs]</a>    <span class="k">def</span> <span class="nf">inject_mem_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mem_einj_type</span><span class="p">,</span>
        <span class="n">mem_addr_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validate_injection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">make</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>

        <span class="n">mem_error_method</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;memory_correctable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memory_correctable_error_cmds</span><span class="p">,</span>
            <span class="s2">&quot;memory_uncorrectable_fatal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memory_uncorrectable_fatal_error_cmds</span><span class="p">,</span>
            <span class="s2">&quot;memory_uncorrectable_non_fatal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memory_uncorrectable_nonfatal_error_cmds</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">einj_failure</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mem_addr_map</span><span class="p">:</span>
            <span class="n">mem_addr_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_address_map</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_identifier</span><span class="p">,</span> <span class="n">mem_addr</span> <span class="ow">in</span> <span class="n">mem_addr_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                <span class="n">injected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">injected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                    <span class="n">sel_log_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">log_message</span><span class="p">()</span>
                <span class="n">command_list</span> <span class="o">=</span> <span class="n">mem_error_method</span><span class="p">[</span><span class="n">mem_einj_type</span><span class="p">](</span><span class="n">mem_addr</span><span class="p">,</span> <span class="n">make</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                        <span class="s2">&quot;Injecting </span><span class="si">{}</span><span class="s2"> on DIMM now&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mem_einj_type</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">command_list</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                <span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">EINJ_INTERFACE</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                            <span class="n">injected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inj_mem</span><span class="p">(</span><span class="n">sel_log_before</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">injected</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;timed out&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="c1"># Wait till the Auto Crash Dump is collected</span>
                        <span class="c1"># Currently power cycling the system after injecting error</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">reboot_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">validate_injection</span><span class="p">:</span>
                            <span class="n">injected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inj_mem</span><span class="p">(</span><span class="n">sel_log_before</span><span class="p">)</span>
                <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span>
                    <span class="n">injected</span><span class="p">,</span>
                    <span class="s2">&quot;inject </span><span class="si">%s</span><span class="s2"> error at memory address </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mem_einj_type</span><span class="p">,</span> <span class="n">mem_addr</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">einj_failure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mem_addr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">einj_failure</span></div>

<div class="viewcode-block" id="SystemBios.check_inj_mem"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_inj_mem">[docs]</a>    <span class="k">def</span> <span class="nf">check_inj_mem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel_log_before</span><span class="p">):</span>
        <span class="n">injected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_log_for_einj</span><span class="p">(</span>
            <span class="s2">&quot;MEMORY_ECC_ERR&quot;</span><span class="p">,</span>
            <span class="n">sel_log_before</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">injected</span></div>


<div class="viewcode-block" id="SystemBios.check_log_for_einj"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_log_for_einj">[docs]</a>    <span class="k">def</span> <span class="nf">check_log_for_einj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">sel_log_before</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if error is injected, from the bmc logs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sel_log_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">log_message</span><span class="p">()</span>
        <span class="n">log_diff</span> <span class="o">=</span> <span class="n">sel_log_after</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">sel_log_before</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">err_type</span> <span class="o">==</span> <span class="s1">&#39;pcie&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;PCIE_ERR&quot;</span> <span class="ow">in</span> <span class="n">log_diff</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;(0xFB)&quot;</span> <span class="ow">and</span> <span class="s2">&quot;(0x20)&quot;</span> <span class="ow">in</span> <span class="n">log_diff</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;(0xFB)&quot;</span> <span class="ow">and</span> <span class="s2">&quot;(20&quot;</span> <span class="ow">in</span> <span class="n">log_diff</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">err_type</span><span class="p">,</span> <span class="n">log_diff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="SystemBios.get_mmap"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_mmap">[docs]</a>    <span class="k">def</span> <span class="nf">get_mmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mem_map</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mem_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Comparing Memory map given in control json</span>
            <span class="c1"># and the one we got from IDK client.</span>
            <span class="c1"># address mapping for any mem address is interpreted as below</span>
            <span class="c1"># (1 1 0 0 1) =&gt; (Node_CPU_Socket, IMC, Channel, Slot, Rank)</span>
            <span class="c1"># ignore the last one as any value to rank will still point to same</span>
            <span class="c1"># dimm</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">arg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="SystemBios.start_idk_server"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.start_idk_server">[docs]</a>    <span class="k">def</span> <span class="nf">start_idk_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the IDK core server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_platform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;skylake&quot;</span><span class="p">:</span>
            <span class="n">start_server</span> <span class="o">=</span> <span class="s2">&quot;./idk_core /listen /no_selftest &amp;&gt; /dev/NULL &amp;&quot;</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span>
            <span class="n">start_server</span><span class="p">,</span>
            <span class="s2">&quot;Start idk server for </span><span class="si">%s</span><span class="s2">, Currently supports skylake only&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_platform&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>  <span class="c1"># noqa</span>
            <span class="n">start_server</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="s2">&quot;/opt/IDK_Server&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.start_idk_client"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.start_idk_client">[docs]</a>    <span class="k">def</span> <span class="nf">start_idk_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the IDK core client</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idk_host</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="n">start_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_platform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;skylake&quot;</span><span class="p">:</span>
            <span class="n">start_client</span> <span class="o">=</span> <span class="s2">&quot;purley_xlate_all.py&quot;</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span>
            <span class="n">start_client</span><span class="p">,</span> <span class="s2">&quot;Start idk client for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_platform&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;python </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">start_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_platform&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="s2">&quot;/opt/IDK_Client&quot;</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span> <span class="s2">&quot;Check for supported processor: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_platform&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="SystemBios.get_address_map"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_address_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_address_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to get the address map from idk client</span>
<span class="sd">        @return - addr_map - Dict with address and a map tuple</span>
<span class="sd">        5-tuple such as (1 1 2 0 1) mapped to a system address 0X304000C100</span>
<span class="sd">        {u&#39;(1 0 1 0 0 )&#39;: u&#39;0X3040000000&#39;,u&#39;(1 1 2 0 0 )&#39;: u&#39;0X3040000100&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_server_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_idk_running</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_idk_client</span><span class="p">()</span>
        <span class="n">addr_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^reverse\s*\((.*?)\)\s*-&gt;\s*(\w+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
            <span class="n">tupl</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="c1"># Ignoring any value lesser than 0X1000, Those addresses are not injectable.</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="n">tupl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tupl</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
                <span class="n">addr_map</span><span class="p">[</span><span class="n">tupl</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="c1"># Kill the IDK server after address map is collected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;killall idk_core&quot;</span><span class="p">)</span>
        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Joining idk_core thread&quot;</span><span class="p">)</span>
        <span class="n">AutovalThread</span><span class="o">.</span><span class="n">wait_for_autoval_thread</span><span class="p">(</span><span class="n">_server_queue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">addr_map</span></div>

<div class="viewcode-block" id="SystemBios.copy_idk_binaries"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.copy_idk_binaries">[docs]</a>    <span class="k">def</span> <span class="nf">copy_idk_binaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy IDK bin from the location given in config file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;rm -rf /opt/IDK_Server /opt/IDK_Client&quot;</span>
        <span class="n">tool_path</span> <span class="o">=</span> <span class="n">SiteUtils</span><span class="p">()</span><span class="o">.</span><span class="n">get_tool_path</span><span class="p">()</span>
        <span class="n">idk_server</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_server&quot;</span><span class="p">])</span>
        <span class="n">idk_client</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idk</span><span class="p">[</span><span class="s2">&quot;idk_client&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cp -ar </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> /opt/&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idk_server</span><span class="p">,</span> <span class="n">idk_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  <span class="c1"># noqa</span></div>

<div class="viewcode-block" id="SystemBios.check_if_idk_running"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_if_idk_running">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_idk_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if IDK core server running. If not, start IDK server</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;ps ax | grep idk_core | grep -v grep&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;IDK core not running, starting IDK....&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_idk_binaries</span><span class="p">()</span>
            <span class="n">_server_thread</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_server_thread</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AutovalThread</span><span class="o">.</span><span class="n">start_autoval_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_idk_server</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># The server needs to start up before the client can run.</span>
            <span class="c1"># Give it 60 seconds</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_server_thread</span></div>

<div class="viewcode-block" id="SystemBios.check_if_error_type_supported"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_if_error_type_supported">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_error_type_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">):</span>
        <span class="n">error_type_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;memory_correctable&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000008&quot;</span><span class="p">,</span>
            <span class="s2">&quot;memory_uncorrectable_fatal&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000020&quot;</span><span class="p">,</span>
            <span class="s2">&quot;memory_uncorrectable_non_fatal&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000010&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pcie_express_correctable&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000040&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pcie_express_uncorrectable_non_fatal&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000080&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pcie_express_uncorrectable_fatal&quot;</span><span class="p">:</span> <span class="s2">&quot;0x00000100&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_einj_supported_in_kernel</span><span class="p">()</span>
        <span class="n">available_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_available_error_types</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error_type_mapping</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="ow">in</span> <span class="n">available_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> not supported&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">error_type_mapping</span><span class="p">[</span><span class="n">error_type</span><span class="p">])</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.check_if_einj_supported_in_kernel"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_if_einj_supported_in_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_einj_supported_in_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kernel_parms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CONFIG_ACPI_APEI_EINJ&quot;</span><span class="p">,</span> <span class="s2">&quot;CONFIG_ACPI_APEI&quot;</span><span class="p">,</span> <span class="s2">&quot;CONFIG_DEBUG_FS&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cat available_error_type&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">EINJ_INTERFACE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Check if einj is supported in kernel, &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;config options to check -  </span><span class="si">%s</span><span class="s2"> &amp; Exception </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kernel_parms</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;Kernel doesn&#39;t support &#39;Error INJection&#39;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.get_available_error_types"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_available_error_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_available_error_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of available error types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cat available_error_type&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">EINJ_INTERFACE</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+)\s+(\w.+)&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">available_error_type</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">available_error_type</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">available_error_type</span></div>

<div class="viewcode-block" id="SystemBios.check_error_injection_supported_types"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.check_error_injection_supported_types">[docs]</a>    <span class="k">def</span> <span class="nf">check_error_injection_supported_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_types_to_inject</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_einj_supported_in_kernel</span><span class="p">()</span></div>

<div class="viewcode-block" id="SystemBios.create_acpi_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.create_acpi_dump">[docs]</a>    <span class="k">def</span> <span class="nf">create_acpi_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acpi_dump_path</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating ACPI dump at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">acpi_dump_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">install_acpidump</span><span class="p">()</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;acpidump &gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">acpi_dump_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;command not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;acpidump not installed.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;Failed to get acpidump output, Error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="SystemBios.get_bios_diff"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_bios_diff">[docs]</a>    <span class="k">def</span> <span class="nf">get_bios_diff</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">bios_before</span><span class="p">,</span> <span class="n">bios_after</span><span class="p">,</span> <span class="n">bios_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_bios</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">bios_before</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">bios_after</span><span class="p">):</span>
            <span class="c1"># Either one of the BIOS before / after dumps doesn&#39;t exist, nothing</span>
            <span class="c1"># to do in this case.</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bios_before</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bdump</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">bios_after</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">adump</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span><span class="n">bdump</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span> <span class="n">adump</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">bios_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bios_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Script File Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Created on&quot;</span><span class="p">,</span> <span class="s2">&quot;HIICrc32=&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">bios_filter</span><span class="p">:</span>
            <span class="n">bios_filter</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;Script File Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Created on&quot;</span><span class="p">,</span> <span class="s2">&quot;HIICrc32=&quot;</span><span class="p">])</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*(</span><span class="si">%s</span><span class="s2">).*&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bios_filter</span><span class="p">)),</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">bios_diff</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Check to make sure three things</span>
        <span class="c1"># 1) No New lines are added in bios except modification</span>
        <span class="c1"># 2) No lines are deleted except modification</span>
        <span class="c1"># 3) The changed lines are the one expected then ignore</span>
        <span class="n">old_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">old_lines</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="n">new_lines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">bios_diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bios_diff</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Difference detected between BIOS settings: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bios_diff</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_new_diff</span><span class="p">(</span><span class="n">bios_after</span><span class="p">):</span>
                <span class="n">bios_dump</span> <span class="o">=</span> <span class="n">bios_after</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;-%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S.gz&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">archive_bios_dump</span><span class="p">(</span><span class="n">bios_after</span><span class="p">,</span> <span class="n">bios_dump</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Full dump at: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bios_dump</span><span class="p">)</span>
        <span class="c1"># Deleting the &quot;after&quot; dump if not flagged save as before and after</span>
        <span class="c1"># are same or the after bump is backed-up</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_after_bios</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -f </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bios_after</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bios_diff</span></div>

    <span class="k">def</span> <span class="nf">_is_new_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bios_dump</span><span class="p">):</span>
        <span class="n">new_diff</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bios_dump</span><span class="p">)</span>
        <span class="n">bios_dump_md5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;md5sum </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bios_dump</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;ls </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">log_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">_file_md5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="s2">&quot;md5sum </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="n">_file</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bios_dump_md5</span> <span class="o">==</span> <span class="n">_file_md5</span><span class="p">:</span>
                <span class="n">new_diff</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">new_diff</span>

<div class="viewcode-block" id="SystemBios.archive_bios_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.archive_bios_dump">[docs]</a>    <span class="nd">@retry</span><span class="p">(</span><span class="n">tries</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sleep_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">exponential</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">archive_bios_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_file</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;gzip -cvf </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.get_current_boot_sequence"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_current_boot_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_boot_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_bios_dump</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boot_options_tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Use boot_options_tokens passed by users to identify the boot sequence</span>
<span class="sd">        ## setting and return.</span>
<span class="sd">        # @param curr_bios_dump - Use this bios settings dump to check the sequence</span>
<span class="sd">        # @param boot_options_tokens - These are the setup question and token</span>
<span class="sd">        #                              number to look for if not passed use the</span>
<span class="sd">        #                              default question and token number</span>
<span class="sd">        # @return - Boot sequence as list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_bios_dump</span><span class="p">:</span>
            <span class="n">curr_bios_dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bios_settings_dump</span><span class="p">(</span><span class="s2">&quot;current_bios_dump.txt&quot;</span><span class="p">)</span>
        <span class="n">parsed_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bios_dump_file</span><span class="p">(</span><span class="n">curr_bios_dump</span><span class="p">)</span>
        <span class="n">make</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">get_manufacturer</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">make</span> <span class="o">==</span> <span class="s2">&quot;wiwynn&quot;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The Boot Sequence setting token for wiwynn system is B3</span>
<span class="sd">            see the setting below</span>
<span class="sd">            ----------------------------------------</span>
<span class="sd">                Setup Question  = Boot Option #</span>
<span class="sd">                Token   =B3 // Do NOT change this line</span>
<span class="sd">                Offset  =00</span>
<span class="sd">                Width   =02</span>
<span class="sd">                ListOrder   =[0000] CentOS</span>
<span class="sd">                         [0005] CentOS</span>
<span class="sd">                         [0003] UEFI: PXE IPv4 Broadcom BCM57302 NetXtreme-C</span>
<span class="sd">                         [0004] UEFI: PXE IPv6 Broadcom BCM57302 NetXtreme-C</span>
<span class="sd">                         [0001] UEFI: Built-in EFI Shell</span>
<span class="sd">            ----------------------------------------</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_settings</span><span class="p">[</span><span class="s2">&quot;Boot Option #&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">seq_token</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parsed_settings</span><span class="p">[</span><span class="s2">&quot;Boot Option #&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;More than two settings with name &#39;Boot Option #&#39; are present in dump&quot;</span><span class="p">)</span>
            <span class="n">current_sequence</span> <span class="o">=</span> <span class="n">parsed_settings</span><span class="p">[</span><span class="s2">&quot;Boot Option #&quot;</span><span class="p">][</span><span class="n">seq_token</span><span class="p">][</span>
                <span class="s2">&quot;ListOrder&quot;</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">current_sequence</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set of Setup Questions and thier respective token to change boot order</span>
<span class="sd">            is mentioned below and it is same for all platforms and doesn&#39;t change</span>
<span class="sd">            The user passed boot sequence option will be enabled to these tokens</span>
<span class="sd">            in the same order to set the boot order</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">boot_options_tokens</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Boot Option #1&quot;</span><span class="p">:</span> <span class="s2">&quot;1080&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Boot Option #2&quot;</span><span class="p">:</span> <span class="s2">&quot;1081&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Boot Option #3&quot;</span><span class="p">:</span> <span class="s2">&quot;1082&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Boot Option #4&quot;</span><span class="p">:</span> <span class="s2">&quot;1083&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">current_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">expected_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\[&quot;</span><span class="p">)</span>
            <span class="n">sorted_keylist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">boot_options_tokens</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">sorted_keylist</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">boot_options_tokens</span><span class="p">[</span><span class="n">question</span><span class="p">]</span>
                <span class="c1"># Filter out the default numbering of options in bios setting</span>
                <span class="c1"># and just get the option string by removing the first 5 characters</span>
                <span class="c1"># which will be the option number</span>
                <span class="n">current_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                        <span class="n">expected_regex</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
                        <span class="n">parsed_settings</span><span class="p">[</span><span class="n">question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Options&quot;</span><span class="p">],</span>
                    <span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">current_sequence</span></div>

<div class="viewcode-block" id="SystemBios.modify_bios_dump"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.modify_bios_dump">[docs]</a>    <span class="k">def</span> <span class="nf">modify_bios_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bios_settings</span><span class="p">,</span> <span class="n">bios_dump_location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Function to modify the given bios_settings in the dump file</span>
<span class="sd">        #  This function will check for options after the matched &quot;Setup Question&quot;.</span>
<span class="sd">        #  and also the token number to exactly match the setting</span>
<span class="sd">        #  when we find a matching pattern for any setting the change will be</span>
<span class="sd">        #  set as passed and the then the setting will be dumped as SCELNX dump</span>
<span class="sd">        #  file</span>
<span class="sd">        #  returns the changed dump file , and both old and new bios settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;chmod 777 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bios_dump_location</span><span class="p">)</span>
        <span class="n">wfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="n">bios_dump_location</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="n">bios_dump_location</span>
        <span class="n">bios_dump_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bios_dump_file</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
        <span class="n">parsed_new_bios</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bios_dump_parsed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">curr_ques</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">bios_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;token&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span>
                        <span class="s2">&quot;Multiple Values found for </span><span class="si">%s</span><span class="s2"> Need BIOS token&quot;</span> <span class="o">%</span>
                        <span class="n">curr_ques</span>
                    <span class="p">)</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;Options&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">option</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Options&quot;</span><span class="p">]</span>
                <span class="n">options_list</span> <span class="o">=</span> <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Options&quot;</span><span class="p">]</span>
                <span class="n">new_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_bios_options</span><span class="p">(</span><span class="n">options_list</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
                <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_list</span>
            <span class="k">elif</span> <span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
                <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="s2">&quot;ListOrder&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">list_order</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;ListOrder&quot;</span><span class="p">]</span>
                <span class="n">parsed_new_bios</span><span class="p">[</span><span class="n">curr_ques</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;ListOrder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_order</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dump_setting_to_file</span><span class="p">(</span><span class="n">parsed_new_bios</span><span class="p">,</span> <span class="n">wfile</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cp -rf </span><span class="si">%s</span><span class="s2">_tmp </span><span class="si">%s</span><span class="s2">; rm -f </span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">bios_dump_location</span><span class="p">,</span>
            <span class="n">bios_dump_location</span><span class="p">,</span>
            <span class="n">bios_dump_location</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bios_dump_location</span><span class="p">,</span> <span class="n">bios_dump_parsed</span><span class="p">,</span> <span class="n">parsed_new_bios</span></div>

<div class="viewcode-block" id="SystemBios.modify_bios_options"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.modify_bios_options">[docs]</a>    <span class="k">def</span> <span class="nf">modify_bios_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options_list</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method enables the option user wants and disables the older enabled</span>
<span class="sd">        option</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\s+|\t+)?\*(.*)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\2&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">options_list</span><span class="p">]</span>
        <span class="c1"># check if there is exact match of option that has to be enabled</span>
        <span class="c1"># if not enable the first option that regex match the option</span>
        <span class="n">new_changed_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\[.*\]</span><span class="si">%s</span><span class="s2">$)&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">change</span><span class="p">),</span> <span class="sa">r</span><span class="s2">&quot;*\1&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">new_list</span>
        <span class="p">]</span>
        <span class="n">changed_opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">new_changed_list</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)]</span>
        <span class="c1"># if there is only one element in changed_opts the option is set</span>
        <span class="c1"># properly else proceed to enable the first match</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_opts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_changed_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">changed_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">matched_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">new_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\[.*\].*</span><span class="si">%s</span><span class="s2">.*)&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">change</span><span class="p">),</span> <span class="n">opt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">matched_flag</span>
                <span class="p">):</span>
                    <span class="n">matched_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">changed_opt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;(\[.*\].*</span><span class="si">%s</span><span class="s2">.*)&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">change</span><span class="p">),</span>
                        <span class="sa">r</span><span class="s2">&quot;*\1&quot;</span><span class="p">,</span>
                        <span class="n">opt</span><span class="p">,</span>
                        <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">changed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changed_opt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">changed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">changed_list</span></div>

<div class="viewcode-block" id="SystemBios.dump_setting_to_file"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.dump_setting_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">dump_setting_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bios_dump_parsed</span><span class="p">,</span> <span class="n">wfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This Method will put all the bios settings from dictionary</span>
<span class="sd">        into a formatted text file where SCELNX tool can pickup</span>
<span class="sd">        and import the settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">wfile</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_f</span><span class="p">:</span>
            <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;// Script File Name : temp_file.txt&quot;</span><span class="p">)</span>
            <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;HIICrc32= JUSTTEMP&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">config_question</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">]:</span>
                    <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Setup Question  = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config_question</span><span class="p">)</span>
                    <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Token   =</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="p">)</span>
                    <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;Offset  =</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Offset&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;Width   =</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Width&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;BIOS Default&quot;</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">]:</span>
                        <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;BIOS Default =</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;BIOS Default&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;MFG Default&quot;</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">]:</span>
                        <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;MFG Default =</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;MFG Default&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">]:</span>
                        <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;Value   =</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="s2">&quot;Options&quot;</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">]:</span>
                        <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Options =</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span><span class="s2">&quot;Options&quot;</span><span class="p">]:</span>
                            <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">opt</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s2">&quot;ListOrder&quot;</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">]:</span>
                        <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ListOrder =&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">bios_dump_parsed</span><span class="p">[</span><span class="n">config_question</span><span class="p">][</span><span class="n">token</span><span class="p">][</span>
                            <span class="s2">&quot;ListOrder&quot;</span>
                        <span class="p">]:</span>
                            <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">opt</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios.parse_bios_dump_file"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.parse_bios_dump_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bios_dump_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">):</span>
        <span class="n">bios_setting_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">config_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(Setup Question|Token|Offset|Width|BIOS Default|MFG Default)\s+=((\s+|\t+)?(.*)(\s+\/\/.*)?)&quot;</span>
        <span class="n">options_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(Options)\s+=((\*)?\[.*\].*((\s+|\t+)\/\/.*)?)&quot;</span>
        <span class="n">value_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(Value)\s+=((\&lt;)?.*(\&gt;)?)&quot;</span>
        <span class="n">listorder_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;ListOrder\s+=(.*)&quot;</span>
        <span class="n">just_option_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(\s+|\t+)((\*)?\[.*\].*((\n|\s+|\t+)\/\/.*)?)&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">current_setup_question</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">current_token</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">current_option</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">new_line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="c1"># remove the commented part from the bios config setting info</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">new_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">config_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">config_regex</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">config_match</span><span class="p">:</span>
                    <span class="n">config_param</span> <span class="o">=</span> <span class="n">config_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">config_value</span> <span class="o">=</span> <span class="n">config_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">config_param</span> <span class="o">==</span> <span class="s2">&quot;Setup Question&quot;</span><span class="p">:</span>
                        <span class="n">current_setup_question</span> <span class="o">=</span> <span class="n">config_value</span>
                        <span class="k">if</span> <span class="n">config_value</span> <span class="ow">and</span> <span class="n">config_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bios_setting_dict</span><span class="p">:</span>
                            <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">config_param</span> <span class="o">==</span> <span class="s2">&quot;Token&quot;</span><span class="p">:</span>
                        <span class="n">current_token</span> <span class="o">=</span> <span class="n">config_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                            <span class="n">config_param</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">config_value</span>
                        <span class="k">continue</span>
                <span class="n">options_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">options_regex</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">options_match</span><span class="p">:</span>
                    <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                        <span class="s2">&quot;Options&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                        <span class="s2">&quot;Options&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">options_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">current_option</span> <span class="o">=</span> <span class="s2">&quot;Options&quot;</span>
                    <span class="k">continue</span>
                <span class="n">list_order_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">listorder_regex</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">list_order_match</span><span class="p">:</span>
                    <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                        <span class="s2">&quot;ListOrder&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                        <span class="s2">&quot;ListOrder&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_order_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">current_option</span> <span class="o">=</span> <span class="s2">&quot;ListOrder&quot;</span>
                    <span class="k">continue</span>
                <span class="n">value_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value_regex</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">value_match</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">value_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                        <span class="n">match</span> <span class="o">+=</span> <span class="s2">&quot; //&quot;</span> <span class="o">+</span> <span class="n">comment</span>
                    <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                        <span class="n">value_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
                    <span class="k">continue</span>
                <span class="n">jus_val_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">just_option_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">jus_val_match</span><span class="p">:</span>
                    <span class="n">bios_setting_dict</span><span class="p">[</span><span class="n">current_setup_question</span><span class="p">][</span><span class="n">current_token</span><span class="p">][</span>
                        <span class="n">current_option</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jus_val_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bios_setting_dict</span></div>

<div class="viewcode-block" id="SystemBios.toggle_option"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.toggle_option">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">rofile</span><span class="p">,</span> <span class="n">i_f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This Method reads each line in option and setup the options user</span>
<span class="sd">        selected and deselect any option that is different from user selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># few lines have tabs and few doesnt so remove tabs with spaces</span>
            <span class="c1"># copy to templine to properly look for regex</span>
            <span class="n">regex_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;    &quot;</span><span class="p">)</span>
            <span class="n">is_our_option</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;(Options\s+)?(\s*)(=)?(\*)?(\[\d+\]</span><span class="si">%s</span><span class="s2">)(.*)&quot;</span> <span class="o">%</span> <span class="n">option</span><span class="p">,</span> <span class="n">regex_line</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_our_option</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_our_option</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">changed_line</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">changed_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;*[&quot;</span><span class="p">)</span>
                <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">changed_line</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">rofile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_not_our_option</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;(Options\s+)?(\s*)(=)?(\*)(\[\d+\].*)&quot;</span><span class="p">,</span> <span class="n">regex_line</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">is_not_our_option</span><span class="p">:</span>
                    <span class="n">changed_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*[&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">changed_line</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">i_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">changed_line</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">rofile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="SystemBios.get_einj_bios_settings"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios.get_einj_bios_settings">[docs]</a>    <span class="k">def</span> <span class="nf">get_einj_bios_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">manu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">get_manufacturer</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">product_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">current_bios_ver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">bios</span><span class="o">.</span><span class="n">get_bios_ver</span><span class="p">()</span>
        <span class="n">einj_settings_path</span> <span class="o">=</span> <span class="s2">&quot;havoc/autoval/lib/host/system/bios/cfg/&quot;</span>
        <span class="n">fs_actions</span> <span class="o">=</span> <span class="n">FilesystemActions</span><span class="p">()</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_einj_bios_settings_filename</span><span class="p">(</span>
            <span class="n">manu</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fs_actions</span><span class="p">,</span> <span class="n">einj_settings_path</span><span class="p">,</span> <span class="n">current_bios_ver</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s2">&quot;Issue in getting the einj bios setting file name for &quot;</span>
            <span class="s2">&quot;Model - </span><span class="si">%s</span><span class="s2"> and Manufacturer - </span><span class="si">%s</span><span class="s2"> and the current BIOS version is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">manu</span><span class="p">,</span> <span class="n">current_bios_ver</span>
            <span class="p">))</span>

        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">fs_actions</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">einj_settings_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">AutovalUtils</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Reading file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fs_actions</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="n">json_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemBios._get_einj_bios_settings_filename"><a class="viewcode-back" href="../../../../../../../havoc.autoval.lib.host.system.bios.html#havoc.autoval.lib.host.system.bios.system_bios.SystemBios._get_einj_bios_settings_filename">[docs]</a>    <span class="k">def</span> <span class="nf">_get_einj_bios_settings_filename</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">manufacturer</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">fs_actions</span><span class="p">,</span>
        <span class="n">einj_settings_path</span><span class="p">,</span>
        <span class="n">current_bios_ver</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To get the BIOS setting&#39;s file name for the respective platform, depending</span>
<span class="sd">        on the device&#39;s BOIS version.</span>
<span class="sd">        If the BIOS version of the device is old</span>
<span class="sd">            - einj_bios_settings_&lt;model&gt;_&lt;manufacturer&gt;_old.json</span>
<span class="sd">        else:</span>
<span class="sd">            - einj_bios_settings_&lt;model&gt;_&lt;manufacturer&gt;.json</span>
<span class="sd">        E.G:</span>
<span class="sd">            einj_bios_settings_tiogapass_quanta.json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_manu</span> <span class="o">=</span> <span class="n">model</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">manufacturer</span>
        <span class="n">bios_einj_settings_path</span> <span class="o">=</span> <span class="n">fs_actions</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">einj_settings_path</span><span class="p">,</span> <span class="s2">&quot;bios_einj_settings.json&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">bios_einj_settings_dict</span> <span class="o">=</span> <span class="n">fs_actions</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
            <span class="n">bios_einj_settings_path</span><span class="p">,</span> <span class="n">json_file</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">bios_einj_settings_dict</span><span class="p">[</span><span class="n">model_manu</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">min_version</span> <span class="o">=</span> <span class="n">bios_einj_settings_dict</span><span class="p">[</span><span class="n">model_manu</span><span class="p">][</span><span class="n">_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;min_version&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">max_version</span> <span class="o">=</span> <span class="n">bios_einj_settings_dict</span><span class="p">[</span><span class="n">model_manu</span><span class="p">][</span><span class="n">_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;max_version&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">current_bios_ver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_version</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">max_version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">current_bios_ver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_version</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">_key</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Copyright (c) 2016-present, Facebook, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>